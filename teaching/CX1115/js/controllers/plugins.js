import{loadScript}from"../utils/loader.js";export default class Plugins{constructor(e){this.Reveal=e,this.state="idle",this.registeredPlugins={},this.asyncDependencies=[]}load(e,i){return this.state="loading",e.forEach(this.registerPlugin.bind(this)),new Promise(e=>{let t=[],n=0;if(i.forEach(e=>{e.condition&&!e.condition()||(e.async?this.asyncDependencies.push(e):t.push(e))}),t.length){n=t.length;const i=i=>{i&&"function"==typeof i.callback&&i.callback(),0==--n&&this.initPlugins().then(e)};t.forEach(e=>{"string"==typeof e.id?(this.registerPlugin(e),i(e)):"string"==typeof e.src?loadScript(e.src,()=>i(e)):(console.warn("Unrecognized plugin format",e),i())})}else this.initPlugins().then(e)})}initPlugins(){return new Promise(e=>{let i=Object.values(this.registeredPlugins),t=i.length;if(0===t)this.loadAsync().then(e);else{let n,s=()=>{0==--t?this.loadAsync().then(e):n()},r=0;(n=(()=>{let e=i[r++];if("function"==typeof e.init){let i=e.init(this.Reveal);i&&"function"==typeof i.then?i.then(s):s()}else s()}))()}})}loadAsync(){return this.state="loaded",this.asyncDependencies.length&&this.asyncDependencies.forEach(e=>{loadScript(e.src,e.callback)}),Promise.resolve()}registerPlugin(e){2===arguments.length&&"string"==typeof arguments[0]?(e=arguments[1]).id=arguments[0]:"function"==typeof e&&(e=e());let i=e.id;"string"!=typeof i?console.warn("Unrecognized plugin format; can't find plugin.id",e):this.registeredPlugins[i]===undefined?(this.registeredPlugins[i]=e,"loaded"===this.state&&"function"==typeof e.init&&e.init(this.Reveal)):console.warn('reveal.js: "'+i+'" plugin has already been registered')}hasPlugin(e){return!!this.registeredPlugins[e]}getPlugin(e){return this.registeredPlugins[e]}getRegisteredPlugins(){return this.registeredPlugins}};