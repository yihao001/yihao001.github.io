import{HORIZONTAL_SLIDES_SELECTOR,VERTICAL_SLIDES_SELECTOR}from"../utils/constants.js";import{extend,queryAll,closest}from"../utils/util.js";import{isMobile}from"../utils/device.js";import fitty from"fitty";export default class SlideContent{constructor(t){this.Reveal=t,this.startEmbeddedIframe=this.startEmbeddedIframe.bind(this)}shouldPreload(t){let e=this.Reveal.getConfig().preloadIframes;return"boolean"!=typeof e&&(e=t.hasAttribute("data-preload")),e}load(t,e={}){t.style.display=this.Reveal.getConfig().display,queryAll(t,"img[data-src], video[data-src], audio[data-src], iframe[data-src]").forEach(t=>{("IFRAME"!==t.tagName||this.shouldPreload(t))&&(t.setAttribute("src",t.getAttribute("data-src")),t.setAttribute("data-lazy-loaded",""),t.removeAttribute("data-src"))}),queryAll(t,"video, audio").forEach(t=>{let e=0;queryAll(t,"source[data-src]").forEach(t=>{t.setAttribute("src",t.getAttribute("data-src")),t.removeAttribute("data-src"),t.setAttribute("data-lazy-loaded",""),e+=1}),isMobile&&"VIDEO"===t.tagName&&t.setAttribute("playsinline",""),e>0&&t.load()});let a=t.slideBackgroundElement;if(a){a.style.display="block";let r=t.slideBackgroundContentElement,s=t.getAttribute("data-background-iframe");if(!1===a.hasAttribute("data-loaded")){a.setAttribute("data-loaded","true");let o=t.getAttribute("data-background-image"),i=t.getAttribute("data-background-video"),d=t.hasAttribute("data-background-video-loop"),l=t.hasAttribute("data-background-video-muted");if(o)r.style.backgroundImage="url("+encodeURI(o)+")";else if(i&&!this.Reveal.isSpeakerNotes()){let t=document.createElement("video");d&&t.setAttribute("loop",""),l&&(t.muted=!0),isMobile&&(t.muted=!0,t.setAttribute("playsinline","")),i.split(",").forEach(e=>{t.innerHTML+='<source src="'+e+'">'}),r.appendChild(t)}else if(s&&!0!==e.excludeIframes){let t=document.createElement("iframe");t.setAttribute("allowfullscreen",""),t.setAttribute("mozallowfullscreen",""),t.setAttribute("webkitallowfullscreen",""),t.setAttribute("allow","autoplay"),t.setAttribute("data-src",s),t.style.width="100%",t.style.height="100%",t.style.maxHeight="100%",t.style.maxWidth="100%",r.appendChild(t)}}let o=r.querySelector("iframe[data-src]");o&&this.shouldPreload(a)&&!/autoplay=(1|true|yes)/gi.test(s)&&o.getAttribute("src")!==s&&o.setAttribute("src",s)}Array.from(t.querySelectorAll(".r-fit-text:not([data-fitted])")).forEach(t=>{t.dataset.fitted="",fitty(t,{minSize:24,maxSize:.8*this.Reveal.getConfig().height,observeMutations:!1,observeWindow:!1})})}unload(t){t.style.display="none";let e=this.Reveal.getSlideBackground(t);e&&(e.style.display="none",queryAll(e,"iframe[src]").forEach(t=>{t.removeAttribute("src")})),queryAll(t,"video[data-lazy-loaded][src], audio[data-lazy-loaded][src], iframe[data-lazy-loaded][src]").forEach(t=>{t.setAttribute("data-src",t.getAttribute("src")),t.removeAttribute("src")}),queryAll(t,"video[data-lazy-loaded] source[src], audio source[src]").forEach(t=>{t.setAttribute("data-src",t.getAttribute("src")),t.removeAttribute("src")})}formatEmbeddedContent(){let t=(t,e,a)=>{queryAll(this.Reveal.getSlidesElement(),"iframe["+t+'*="'+e+'"]').forEach(e=>{let r=e.getAttribute(t);r&&-1===r.indexOf(a)&&e.setAttribute(t,r+(/\?/.test(r)?"&":"?")+a)})};t("src","youtube.com/embed/","enablejsapi=1"),t("data-src","youtube.com/embed/","enablejsapi=1"),t("src","player.vimeo.com/","api=1"),t("data-src","player.vimeo.com/","api=1")}startEmbeddedContent(t){t&&!this.Reveal.isSpeakerNotes()&&(queryAll(t,'img[src$=".gif"]').forEach(t=>{t.setAttribute("src",t.getAttribute("src"))}),queryAll(t,"video, audio").forEach(t=>{if(closest(t,".fragment")&&!closest(t,".fragment.visible"))return;let e=this.Reveal.getConfig().autoPlayMedia;if("boolean"!=typeof e&&(e=t.hasAttribute("data-autoplay")||!!closest(t,".slide-background")),e&&"function"==typeof t.play)if(t.readyState>1)this.startEmbeddedMedia({target:t});else if(isMobile){let e=t.play();e&&"function"==typeof e["catch"]&&!1===t.controls&&e["catch"](()=>{t.controls=!0,t.addEventListener("play",()=>{t.controls=!1})})}else t.removeEventListener("loadeddata",this.startEmbeddedMedia),t.addEventListener("loadeddata",this.startEmbeddedMedia)}),queryAll(t,"iframe[src]").forEach(t=>{closest(t,".fragment")&&!closest(t,".fragment.visible")||this.startEmbeddedIframe({target:t})}),queryAll(t,"iframe[data-src]").forEach(t=>{closest(t,".fragment")&&!closest(t,".fragment.visible")||t.getAttribute("src")!==t.getAttribute("data-src")&&(t.removeEventListener("load",this.startEmbeddedIframe),t.addEventListener("load",this.startEmbeddedIframe),t.setAttribute("src",t.getAttribute("data-src")))}))}startEmbeddedMedia(t){let e=!!closest(t.target,"html"),a=!!closest(t.target,".present");e&&a&&(t.target.currentTime=0,t.target.play()),t.target.removeEventListener("loadeddata",this.startEmbeddedMedia)}startEmbeddedIframe(t){let e=t.target;if(e&&e.contentWindow){let a=!!closest(t.target,"html"),r=!!closest(t.target,".present");if(a&&r){let t=this.Reveal.getConfig().autoPlayMedia;"boolean"!=typeof t&&(t=e.hasAttribute("data-autoplay")||!!closest(e,".slide-background")),/youtube\.com\/embed\//.test(e.getAttribute("src"))&&t?e.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}',"*"):/player\.vimeo\.com\//.test(e.getAttribute("src"))&&t?e.contentWindow.postMessage('{"method":"play"}',"*"):e.contentWindow.postMessage("slide:start","*")}}}stopEmbeddedContent(t,e={}){e=extend({unloadIframes:!0},e),t&&t.parentNode&&(queryAll(t,"video, audio").forEach(t=>{t.hasAttribute("data-ignore")||"function"!=typeof t.pause||(t.setAttribute("data-paused-by-reveal",""),t.pause())}),queryAll(t,"iframe").forEach(t=>{t.contentWindow&&t.contentWindow.postMessage("slide:stop","*"),t.removeEventListener("load",this.startEmbeddedIframe)}),queryAll(t,'iframe[src*="youtube.com/embed/"]').forEach(t=>{!t.hasAttribute("data-ignore")&&t.contentWindow&&"function"==typeof t.contentWindow.postMessage&&t.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}',"*")}),queryAll(t,'iframe[src*="player.vimeo.com/"]').forEach(t=>{!t.hasAttribute("data-ignore")&&t.contentWindow&&"function"==typeof t.contentWindow.postMessage&&t.contentWindow.postMessage('{"method":"pause"}',"*")}),!0===e.unloadIframes&&queryAll(t,"iframe[data-src]").forEach(t=>{t.setAttribute("src","about:blank"),t.removeAttribute("src")}))}};